<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>คลังยา - หนีน้ำท่วม</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg-page: #020617;
      --bg-card: #020617;
      --bg-elevated: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.12);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(148,163,184,0.35);
      --danger: #f97373;
      --success: #4ade80;
      --radius-xl: 18px;
      --shadow-soft: 0 24px 60px rgba(15,23,42,0.7);
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px 16px 40px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b, #020617 55%);
      color: var(--text-main);
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(15,23,42,0.92));
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 18px 20px;
      margin-bottom: 18px;
    }

    .app-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    .app-title {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.02em;
      margin: 6px 0 4px;
    }

    .app-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      font-size: 11px;
      color: var(--accent);
      background: rgba(15,23,42,0.9);
    }

    .meta-col {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .meta-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .meta-label {
      opacity: 0.85;
    }

    .meta-value {
      color: var(--text-main);
    }

    button.primary,
    button.ghost {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      background: transparent;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.primary {
      background: radial-gradient(circle at top left, var(--accent), #0ea5e9);
      border-color: transparent;
      color: #0b1120;
      box-shadow: 0 10px 30px rgba(56,189,248,0.3);
    }

    button.primary:hover {
      filter: brightness(1.05);
    }

    button.ghost {
      border-color: var(--border-subtle);
      background: rgba(15,23,42,0.8);
      color: var(--text-muted);
    }

    button.ghost:hover {
      border-color: var(--accent-soft);
      color: var(--accent);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .global-message {
      max-width: 1100px;
      margin: 0 auto 12px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
    }

    .global-message.error {
      border: 1px solid rgba(248,113,113,0.4);
      background: rgba(127,29,29,0.7);
    }

    .hidden {
      display: none !important;
    }

    .field-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .search-wrapper {
      margin-top: 4px;
    }

    .search-input {
      width: 100%;
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      font-size: 13px;
    }

    .search-input::placeholder {
      color: rgba(148,163,184,0.7);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.55);
    }

    .table-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .table-title {
      font-size: 14px;
      font-weight: 500;
    }

    /* สำคัญ: ทำให้ตาราง scroll ได้ทั้งแนวตั้งและแนวนอน */
    .table-wrapper {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.35);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.08), rgba(15,23,42,0.96));
      max-height: 70vh;              /* จำกัดความสูง และให้ scroll ด้านใน */
      overflow-y: auto;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    /* บังคับให้มี horizontal scroll เมื่อจอแคบ */
    @media (max-width: 1024px) {
      table {
        min-width: 720px;
      }
    }

    @media (max-width: 640px) {
      table {
        min-width: 640px;
      }
    }

    thead {
      background: rgba(15,23,42,0.96);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(15,23,42,0.9);
      white-space: nowrap;   /* ป้องกันตัวหนังสือลงบรรทัดใหม่ ทำให้เลื่อนซ้ายขวาแทน */
    }

    th {
      text-align: left;
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(148,163,184,0.9);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.86);
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.8);
    }

    tbody tr:hover {
      background: rgba(51,65,85,0.9);
    }

    .cell-name {
      font-size: 13px;
    }

    .cell-qty {
      width: 140px;
    }

    .cell-unit {
      width: 90px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .quantity-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 74px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.6);
    }

    .empty-state {
      padding: 12px 14px;
      font-size: 12px;
      color: var(--text-muted);
      white-space: normal;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .admin-title {
      font-size: 15px;
      font-weight: 500;
    }

    .admin-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .admin-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 4px;
    }

    .form-grid {
      display: grid;
      gap: 12px;
    }

    @media (min-width: 720px) {
      .form-grid {
        grid-template-columns: 1.2fr 1.2fr;
      }
    }

    .field-input {
      width: 100%;
      border-radius: 10px;
      padding: 9px 11px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      font-size: 13px;
    }

    .field-input::placeholder {
      color: rgba(148,163,184,0.7);
    }

    .field-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.45);
    }

    .field-inline {
      display: flex;
      gap: 10px;
    }

    .field-inline-col {
      flex: 1;
    }

    .hint {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .admin-footer-row {
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap-reverse;
    }

    .admin-message {
      font-size: 12px;
      min-height: 18px;
    }

    .admin-message.error {
      color: var(--danger);
    }

    .admin-message.success {
      color: var(--success);
    }

    .field-input.readonly {
      background: rgba(15,23,42,0.7);
      border-style: dashed;
    }

    .tabs-card {
      padding: 10px 14px;
      margin-top: -6px;
      margin-bottom: 14px;
    }

    .tabs {
      display: inline-flex;
      gap: 6px;
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      padding: 4px;
      border: 1px solid var(--border-subtle);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .tab {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-muted);
      padding: 6px 16px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    .tab.active {
      background: var(--accent-soft);
      color: var(--accent);
    }

    @media (max-width: 640px) {
      body {
        padding: 16px 12px 32px;
      }

      .card {
        padding: 14px 14px;
      }

      th, td {
        padding: 8px 10px;
      }

      .app-title {
        font-size: 18px;
      }

      .app-subtitle {
        font-size: 12px;
      }

      .meta-col {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="card app-header">
      <div>
        <div class="badge">Pharmacy Inventory</div>
        <div class="app-title">คลังยา หนีน้ำท่วม</div>
        <div class="app-subtitle">ดูยอดคงเหลือ รับเข้า จ่ายออก PO และประวัติจาก Google Sheet</div>
      </div>
      <div class="meta-col">
        <div class="meta-row">
          <span class="meta-label">อัปเดตล่าสุด (คลังยา):</span>
          <span id="last-updated" class="meta-value">-</span>
        </div>
        <div class="meta-row">
          <span id="rows-count" class="meta-value">- รายการ</span>
          <button class="ghost" id="refresh-btn" type="button">รีเฟรช</button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="card tabs-card">
      <div class="tabs">
        <button type="button" id="tab-inventory" class="tab active">คลังยา</button>
        <button type="button" id="tab-po" class="tab">PO รอจัดส่ง</button>
        <button type="button" id="tab-tx" class="tab">ประวัติ & รายการใหม่</button>
      </div>
    </div>

    <div id="global-error" class="global-message hidden"></div>

    <!-- PAGE: INVENTORY -->
    <div id="page-inventory">
      <div class="card">
        <label class="field-label" for="search-input">ค้นหาชื่อยา</label>
        <div class="search-wrapper">
          <input id="search-input" type="text" class="search-input"
                 placeholder="พิมพ์ชื่อยา เช่น adrenaline, nitroglycerine ..."
                 autocomplete="off">
        </div>
      </div>

      <div class="card">
        <div class="table-header-row">
          <div class="table-title">รายการยาในคลัง</div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>ชื่อยา</th>
                <th style="width: 140px;">จำนวนคงเหลือ</th>
                <th style="width: 90px;">หน่วย</th>
              </tr>
            </thead>
            <tbody id="inventory-tbody"></tbody>
          </table>
          <div id="empty-state" class="empty-state hidden">
            ไม่พบข้อมูลตรงกับการค้นหา
          </div>
        </div>
      </div>

      <div class="card">
        <div class="admin-header">
          <div>
            <div class="admin-title">Admin · รับเข้า / จ่ายออก</div>
            <div class="admin-subtitle">อัปเดตจำนวนคงเหลือในคลัง (เฉพาะผู้ดูแลระบบ)</div>
          </div>
        </div>
        <form id="admin-form" class="admin-form">
          <div class="form-grid">
            <div class="field">
              <label for="admin-password" class="field-label">รหัสผ่าน Admin</label>
              <input id="admin-password" type="password" class="field-input"
                     autocomplete="current-password" required>
            </div>
            <div class="field">
              <label for="item-name" class="field-label">ชื่อยา</label>
              <input id="item-name" type="text" class="field-input"
                     list="item-suggestions" autocomplete="off" required>
              <datalist id="item-suggestions"></datalist>
              <div class="hint">ถ้าเลือกชื่อยาจากรายการ ระบบจะดึงหน่วยให้โดยอัตโนมัติ</div>
            </div>
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="item-unit" class="field-label">หน่วย</label>
              <input id="item-unit" type="text" class="field-input" required>
            </div>
            <div class="field field-inline">
              <div class="field-inline-col">
                <label for="item-amount" class="field-label">จำนวน</label>
                <input id="item-amount" type="number" min="1" step="1"
                       class="field-input" required>
              </div>
              <div class="field-inline-col">
                <label for="action-type" class="field-label">ประเภท</label>
                <select id="action-type" class="field-input">
                  <option value="in">รับเข้า</option>
                  <option value="out">จ่ายออก</option>
                </select>
              </div>
            </div>
          </div>

          <div class="admin-footer-row">
            <div id="admin-message" class="admin-message"></div>
            <button type="submit" class="primary">บันทึกการเคลื่อนไหว</button>
          </div>
        </form>
      </div>
    </div>

    <!-- PAGE: PO รอจัดส่ง -->
    <div id="page-po" class="hidden">
      <div class="card">
        <label class="field-label" for="po-search-input">ค้นหา (Item / Vendor / PO)</label>
        <div class="search-wrapper">
          <input id="po-search-input" type="text" class="search-input"
                 placeholder="ค้นหาชื่อยา, vendor หรือ PO number"
                 autocomplete="off">
        </div>
      </div>

      <div class="card">
        <div class="table-header-row">
          <div class="table-title">รายการ PO ยาที่รอจัดส่ง</div>
          <div class="meta-row">
            <span class="meta-label">อัปเดตล่าสุด (PO):</span>
            <span id="po-last-updated" class="meta-value">-</span>
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Item name</th>
                <th>QTY</th>
                <th>Unit</th>
                <th>Delivery date</th>
                <th>Vendor</th>
                <th>PR Status</th>
                <th>PO Number</th>
              </tr>
            </thead>
            <tbody id="po-tbody"></tbody>
          </table>
          <div id="po-empty-state" class="empty-state hidden">
            ไม่พบข้อมูล PO ตรงกับการค้นหา
          </div>
        </div>
        <div class="meta-row" style="margin-top: 10px;">
          <span class="meta-label">จำนวนรายการ PO:</span>
          <span id="po-rows-count" class="meta-value">-</span>
        </div>
      </div>
    </div>

    <!-- PAGE: Transaction & New items -->
    <div id="page-tx" class="hidden">
      <div class="card">
        <label class="field-label" for="tx-search-input">ค้นหา (ชื่อยา / ประเภท)</label>
        <div class="search-wrapper">
          <input id="tx-search-input" type="text" class="search-input"
                 placeholder="ค้นหาจากชื่อยา หรือประเภท in/out"
                 autocomplete="off">
        </div>
      </div>

      <div class="card">
        <div class="table-header-row">
          <div class="table-title">ประวัติการเคลื่อนไหวคลังยา</div>
          <div class="meta-row">
            <span class="meta-label">อัปเดตล่าสุด (Transaction):</span>
            <span id="tx-last-updated" class="meta-value">-</span>
          </div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>เวลา</th>
                <th>ประเภท</th>
                <th>ชื่อยา</th>
                <th>เปลี่ยนแปลง</th>
                <th>หน่วย</th>
                <th>คงเหลือหลังเคลื่อนไหว</th>
              </tr>
            </thead>
            <tbody id="tx-tbody"></tbody>
          </table>
          <div id="tx-empty-state" class="empty-state hidden">
            ยังไม่มีประวัติการเคลื่อนไหว หรือไม่พบข้อมูลตรงกับการค้นหา
          </div>
        </div>
        <div class="meta-row" style="margin-top: 10px;">
          <span class="meta-label">จำนวนรายการ:</span>
          <span id="tx-rows-count" class="meta-value">-</span>
        </div>
      </div>

      <div class="card">
        <div class="table-header-row">
          <div class="table-title">New items (รายการยาใหม่ที่ถูกเพิ่มเข้าคลังครั้งแรก)</div>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>ชื่อยา</th>
                <th>หน่วย</th>
                <th>วันที่เพิ่มครั้งแรก</th>
                <th>จำนวนครั้งแรก</th>
              </tr>
            </thead>
            <tbody id="new-items-tbody"></tbody>
          </table>
        </div>
        <div class="meta-row" style="margin-top: 10px;">
          <span class="meta-label">จำนวน New items:</span>
          <span id="new-items-rows-count" class="meta-value">-</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // TODO: เปลี่ยนเป็น URL Web App ของ Google Apps Script ที่ Deploy แล้ว
    const API_URL = 'PUT_YOUR_WEB_APP_URL_HERE';

    let inventoryData = [];
    let poData = [];
    let txData = [];
    let newItemsData = [];
    let isLoading = false;
    let currentPage = 'inventory';

    const elements = {
      // Inventory
      tableBody: document.getElementById('inventory-tbody'),
      searchInput: document.getElementById('search-input'),
      lastUpdated: document.getElementById('last-updated'),
      rowsCount: document.getElementById('rows-count'),
      emptyState: document.getElementById('empty-state'),
      refreshBtn: document.getElementById('refresh-btn'),
      adminForm: document.getElementById('admin-form'),
      adminMessage: document.getElementById('admin-message'),
      adminPassword: document.getElementById('admin-password'),
      itemName: document.getElementById('item-name'),
      itemUnit: document.getElementById('item-unit'),
      itemAmount: document.getElementById('item-amount'),
      actionType: document.getElementById('action-type'),
      itemSuggestions: document.getElementById('item-suggestions'),

      // PO
      poTableBody: document.getElementById('po-tbody'),
      poEmptyState: document.getElementById('po-empty-state'),
      poLastUpdated: document.getElementById('po-last-updated'),
      poRowsCount: document.getElementById('po-rows-count'),
      poSearchInput: document.getElementById('po-search-input'),

      // Transactions & New items
      txTableBody: document.getElementById('tx-tbody'),
      txEmptyState: document.getElementById('tx-empty-state'),
      txLastUpdated: document.getElementById('tx-last-updated'),
      txRowsCount: document.getElementById('tx-rows-count'),
      txSearchInput: document.getElementById('tx-search-input'),
      newItemsTableBody: document.getElementById('new-items-tbody'),
      newItemsRowsCount: document.getElementById('new-items-rows-count'),

      // Tabs / pages
      tabInventory: document.getElementById('tab-inventory'),
      tabPo: document.getElementById('tab-po'),
      tabTx: document.getElementById('tab-tx'),
      pageInventory: document.getElementById('page-inventory'),
      pagePo: document.getElementById('page-po'),
      pageTx: document.getElementById('page-tx'),

      // Global
      globalError: document.getElementById('global-error')
    };

    function setLoading(active) {
      isLoading = active;
      if (elements.refreshBtn) {
        elements.refreshBtn.disabled = active;
      }
    }

    function showGlobalError(message) {
      if (!elements.globalError) return;
      if (!message) {
        elements.globalError.classList.add('hidden');
        elements.globalError.textContent = '';
        return;
      }
      elements.globalError.textContent = message;
      elements.globalError.classList.remove('hidden');
      elements.globalError.classList.add('error');
    }

    function formatNumber(value) {
      const n = Number(value) || 0;
      if (Number.isInteger(n)) {
        return n.toLocaleString('th-TH');
      }
      return n.toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function formatDate(value) {
      if (!value) return '-';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) {
        return String(value);
      }
      return d.toLocaleDateString('th-TH');
    }

    function formatDateTime(value) {
      if (!value) return '-';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) {
        return String(value);
      }
      return d.toLocaleString('th-TH');
    }

    function renderInventoryTable(list) {
      if (!elements.tableBody) return;
      const tbody = elements.tableBody;
      tbody.innerHTML = '';
      if (!list || list.length === 0) {
        elements.emptyState && elements.emptyState.classList.remove('hidden');
      } else {
        elements.emptyState && elements.emptyState.classList.add('hidden');
      }

      (list || []).forEach(row => {
        const tr = document.createElement('tr');

        const nameTd = document.createElement('td');
        nameTd.className = 'cell-name';
        nameTd.textContent = row.item || '';

        const qtyTd = document.createElement('td');
        qtyTd.className = 'cell-qty';
        const pill = document.createElement('span');
        pill.className = 'quantity-pill';
        pill.textContent = formatNumber(row.quantity);
        qtyTd.appendChild(pill);

        const unitTd = document.createElement('td');
        unitTd.className = 'cell-unit';
        unitTd.textContent = row.unit || '-';

        tr.appendChild(nameTd);
        tr.appendChild(qtyTd);
        tr.appendChild(unitTd);
        tbody.appendChild(tr);
      });

      if (elements.rowsCount) {
        elements.rowsCount.textContent = (list ? list.length : 0) + ' รายการ';
      }
    }

    function renderPoTable(list) {
      if (!elements.poTableBody) return;
      const tbody = elements.poTableBody;
      tbody.innerHTML = '';

      if (!list || list.length === 0) {
        elements.poEmptyState && elements.poEmptyState.classList.remove('hidden');
      } else {
        elements.poEmptyState && elements.poEmptyState.classList.add('hidden');
      }

      (list || []).forEach(row => {
        const tr = document.createElement('tr');

        const itemTd = document.createElement('td');
        itemTd.className = 'cell-name';
        itemTd.textContent = row.itemName || '';

        const qtyTd = document.createElement('td');
        qtyTd.className = 'cell-qty';
        const qtyPill = document.createElement('span');
        qtyPill.className = 'quantity-pill';
        qtyPill.textContent = formatNumber(row.qty);
        qtyTd.appendChild(qtyPill);

        const unitTd = document.createElement('td');
        unitTd.className = 'cell-unit';
        unitTd.textContent = row.unit || '-';

        const dateTd = document.createElement('td');
        dateTd.textContent = formatDate(row.deliveryDate);

        const vendorTd = document.createElement('td');
        vendorTd.textContent = row.vendor || '';

        const statusTd = document.createElement('td');
        statusTd.textContent = row.prStatus || '';

        const poTd = document.createElement('td');
        poTd.textContent = row.poNumber || '';

        tr.appendChild(itemTd);
        tr.appendChild(qtyTd);
        tr.appendChild(unitTd);
        tr.appendChild(dateTd);
        tr.appendChild(vendorTd);
        tr.appendChild(statusTd);
        tr.appendChild(poTd);

        tbody.appendChild(tr);
      });

      if (elements.poRowsCount) {
        elements.poRowsCount.textContent = (list ? list.length : 0) + ' รายการ';
      }
    }

    function renderTxTable(list) {
      if (!elements.txTableBody) return;
      const tbody = elements.txTableBody;
      tbody.innerHTML = '';

      if (!list || list.length === 0) {
        elements.txEmptyState && elements.txEmptyState.classList.remove('hidden');
      } else {
        elements.txEmptyState && elements.txEmptyState.classList.add('hidden');
      }

      (list || []).forEach(row => {
        const tr = document.createElement('tr');

        const tsTd = document.createElement('td');
        tsTd.textContent = formatDateTime(row.timestamp);

        const actionTd = document.createElement('td');
        const action = (row.action || '').toLowerCase();
        actionTd.textContent = action === 'in'
          ? 'รับเข้า'
          : action === 'out'
          ? 'จ่ายออก'
          : row.action || '';

        const itemTd = document.createElement('td');
        itemTd.className = 'cell-name';
        itemTd.textContent = row.item || '';

        const changeTd = document.createElement('td');
        const pill = document.createElement('span');
        pill.className = 'quantity-pill';
        const prefix = row.change > 0 ? '+' : '';
        pill.textContent = prefix + formatNumber(row.change);
        changeTd.appendChild(pill);

        const unitTd = document.createElement('td');
        unitTd.className = 'cell-unit';
        unitTd.textContent = row.unit || '-';

        const newQtyTd = document.createElement('td');
        newQtyTd.textContent = formatNumber(row.newQuantity);

        tr.appendChild(tsTd);
        tr.appendChild(actionTd);
        tr.appendChild(itemTd);
        tr.appendChild(changeTd);
        tr.appendChild(unitTd);
        tr.appendChild(newQtyTd);

        tbody.appendChild(tr);
      });

      if (elements.txRowsCount) {
        elements.txRowsCount.textContent = (list ? list.length : 0) + ' รายการ';
      }
    }

    function renderNewItemsTable(list) {
      if (!elements.newItemsTableBody) return;
      const tbody = elements.newItemsTableBody;
      tbody.innerHTML = '';

      (list || []).forEach(row => {
        const tr = document.createElement('tr');

        const itemTd = document.createElement('td');
        itemTd.className = 'cell-name';
        itemTd.textContent = row.item || '';

        const unitTd = document.createElement('td');
        unitTd.className = 'cell-unit';
        unitTd.textContent = row.unit || '-';

        const tsTd = document.createElement('td');
        tsTd.textContent = formatDate(row.timestamp);

        const qtyTd = document.createElement('td');
        const pill = document.createElement('span');
        pill.className = 'quantity-pill';
        pill.textContent = formatNumber(row.newQuantity);
        qtyTd.appendChild(pill);

        tr.appendChild(itemTd);
        tr.appendChild(unitTd);
        tr.appendChild(tsTd);
        tr.appendChild(qtyTd);

        tbody.appendChild(tr);
      });

      if (elements.newItemsRowsCount) {
        elements.newItemsRowsCount.textContent = (list ? list.length : 0) + ' รายการ';
      }
    }

    function updateLastUpdated(isoString) {
      if (!elements.lastUpdated) return;
      if (!isoString) {
        elements.lastUpdated.textContent = '-';
        return;
      }
      const d = new Date(isoString);
      if (Number.isNaN(d.getTime())) {
        elements.lastUpdated.textContent = '-';
        return;
      }
      elements.lastUpdated.textContent = d.toLocaleString('th-TH');
    }

    function updatePoLastUpdated(isoString) {
      if (!elements.poLastUpdated) return;
      if (!isoString) {
        elements.poLastUpdated.textContent = '-';
        return;
      }
      const d = new Date(isoString);
      if (Number.isNaN(d.getTime())) {
        elements.poLastUpdated.textContent = '-';
        return;
      }
      elements.poLastUpdated.textContent = d.toLocaleString('th-TH');
    }

    function updateTxLastUpdated(isoString) {
      if (!elements.txLastUpdated) return;
      if (!isoString) {
        elements.txLastUpdated.textContent = '-';
        return;
      }
      const d = new Date(isoString);
      if (Number.isNaN(d.getTime())) {
        elements.txLastUpdated.textContent = '-';
        return;
      }
      elements.txLastUpdated.textContent = d.toLocaleString('th-TH');
    }

    function updateItemSuggestions(list) {
      if (!elements.itemSuggestions) return;
      const datalist = elements.itemSuggestions;
      datalist.innerHTML = '';
      const seen = new Set();
      (list || []).forEach(row => {
        const name = (row.item || '').trim();
        if (!name || seen.has(name.toLowerCase())) return;
        seen.add(name.toLowerCase());
        const option = document.createElement('option');
        option.value = name;
        datalist.appendChild(option);
      });
    }

    function applyFilterAndRender() {
      if (!elements.searchInput) {
        renderInventoryTable(inventoryData);
        return;
      }
      const term = elements.searchInput.value.trim().toLowerCase();
      if (!term) {
        renderInventoryTable(inventoryData);
        return;
      }
      const filtered = inventoryData.filter(row =>
        (row.item || '').toLowerCase().includes(term)
      );
      renderInventoryTable(filtered);
    }

    function applyPoFilterAndRender() {
      if (!elements.poSearchInput) {
        renderPoTable(poData);
        return;
      }
      const term = elements.poSearchInput.value.trim().toLowerCase();
      if (!term) {
        renderPoTable(poData);
        return;
      }
      const filtered = poData.filter(row =>
        (row.itemName || '').toLowerCase().includes(term) ||
        (row.vendor   || '').toLowerCase().includes(term) ||
        (row.poNumber || '').toLowerCase().includes(term)
      );
      renderPoTable(filtered);
    }

    function applyTxFilterAndRender() {
      if (!elements.txSearchInput) {
        renderTxTable(txData);
        return;
      }
      const term = elements.txSearchInput.value.trim().toLowerCase();
      if (!term) {
        renderTxTable(txData);
        return;
      }
      const filtered = txData.filter(row => {
        const action = (row.action || '').toLowerCase();
        return (row.item || '').toLowerCase().includes(term) ||
               action.includes(term);
      });
      renderTxTable(filtered);
    }

    async function fetchInventory() {
      setLoading(true);
      showGlobalError('');
      try {
        const res = await fetch(API_URL + '?action=list');
        if (!res.ok) {
          throw new Error('เชื่อมต่อ Google Apps Script ไม่ได้ (' + res.status + ')');
        }
        const data = await res.json();
        if (!data.success) {
          throw new Error(data.error || 'ไม่สามารถโหลดข้อมูลจาก Sheet ได้');
        }
        inventoryData = data.data || [];
        updateLastUpdated(data.updatedAt);
        updateItemSuggestions(inventoryData);
        applyFilterAndRender();
      } catch (err) {
        showGlobalError(err.message || 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
        inventoryData = [];
        renderInventoryTable([]);
      } finally {
        setLoading(false);
      }
    }

    async function fetchPo() {
      setLoading(true);
      showGlobalError('');
      try {
        const res = await fetch(API_URL + '?action=list_po');
        if (!res.ok) {
          throw new Error('เชื่อมต่อ Google Apps Script (PO) ไม่ได้ (' + res.status + ')');
        }
        const data = await res.json();
        if (!data.success) {
          throw new Error(data.error || 'ไม่สามารถโหลดข้อมูล PO จาก Sheet ได้');
        }
        poData = data.data || [];
        updatePoLastUpdated(data.updatedAt);
        applyPoFilterAndRender();
      } catch (err) {
        showGlobalError(err.message || 'เกิดข้อผิดพลาดในการโหลดข้อมูล PO');
        poData = [];
        renderPoTable([]);
      } finally {
        setLoading(false);
      }
    }

    async function fetchTransactions() {
      setLoading(true);
      showGlobalError('');
      try {
        const res = await fetch(API_URL + '?action=list_tx');
        if (!res.ok) {
          throw new Error('เชื่อมต่อ Google Apps Script (Transaction) ไม่ได้ (' + res.status + ')');
        }
        const data = await res.json();
        if (!data.success) {
          throw new Error(data.error || 'ไม่สามารถโหลดข้อมูล Transaction จาก Sheet ได้');
        }
        const payload = data.data || {};
        txData = payload.transactions || [];
        newItemsData = payload.newItems || [];
        updateTxLastUpdated(data.updatedAt);
        applyTxFilterAndRender();
        renderNewItemsTable(newItemsData);
      } catch (err) {
        showGlobalError(err.message || 'เกิดข้อผิดพลาดในการโหลด Transaction');
        txData = [];
        newItemsData = [];
        renderTxTable([]);
        renderNewItemsTable([]);
      } finally {
        setLoading(false);
      }
    }

    function autoFillUnitFromItem() {
      if (!elements.itemName || !elements.itemUnit) return;
      const name = elements.itemName.value.trim().toLowerCase();
      if (!name) {
        elements.itemUnit.readOnly = false;
        elements.itemUnit.classList.remove('readonly');
        return;
      }
      const match = inventoryData.find(row =>
        (row.item || '').toLowerCase() === name
      );
      if (match && match.unit) {
        elements.itemUnit.value = match.unit;
        elements.itemUnit.readOnly = true;
        elements.itemUnit.classList.add('readonly');
      } else {
        elements.itemUnit.readOnly = false;
        elements.itemUnit.classList.remove('readonly');
      }
    }

    function clearAdminMessage() {
      if (!elements.adminMessage) return;
      elements.adminMessage.textContent = '';
      elements.adminMessage.classList.remove('error', 'success');
    }

    function showAdminMessage(message, type) {
      if (!elements.adminMessage) return;
      elements.adminMessage.textContent = message;
      elements.adminMessage.classList.remove('error', 'success');
      if (type === 'error') {
        elements.adminMessage.classList.add('error');
      } else if (type === 'success') {
        elements.adminMessage.classList.add('success');
      }
    }

    async function handleAdminSubmit(event) {
      event.preventDefault();
      clearAdminMessage();

      if (!elements.adminPassword || !elements.itemName || !elements.itemUnit || !elements.itemAmount || !elements.actionType) {
        showAdminMessage('ฟอร์มไม่ครบถ้วน', 'error');
        return;
      }

      const password = elements.adminPassword.value.trim();
      const itemName = elements.itemName.value.trim();
      const unit = elements.itemUnit.value.trim();
      const amountStr = elements.itemAmount.value.trim();
      const actionType = elements.actionType.value;

      if (!password || !itemName || !unit || !amountStr) {
        showAdminMessage('กรุณากรอกข้อมูลให้ครบ', 'error');
        return;
      }

      const amount = parseFloat(amountStr);
      if (!Number.isFinite(amount) || amount <= 0) {
        showAdminMessage('จำนวนต้องมากกว่า 0', 'error');
        return;
      }

      try {
        const body = new URLSearchParams();
        body.append('action', 'adjust');
        body.append('password', password);
        body.append('itemName', itemName);
        body.append('unit', unit);
        body.append('change', String(amount));
        body.append('direction', actionType);

        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body: body.toString()
        });

        const data = await res.json();
        if (!data.success) {
          throw new Error(data.error || 'ไม่สามารถบันทึกข้อมูลได้');
        }

        showAdminMessage(data.message || 'บันทึกสำเร็จ', 'success');
        elements.itemAmount.value = '';
        await fetchInventory();
      } catch (err) {
        showAdminMessage(err.message || 'เกิดข้อผิดพลาด', 'error');
      }
    }

    function switchPage(page) {
      if (page === currentPage) return;
      currentPage = page;

      if (elements.pageInventory && elements.pagePo && elements.pageTx) {
        if (page === 'inventory') {
          elements.pageInventory.classList.remove('hidden');
          elements.pagePo.classList.add('hidden');
          elements.pageTx.classList.add('hidden');
        } else if (page === 'po') {
          elements.pageInventory.classList.add('hidden');
          elements.pagePo.classList.remove('hidden');
          elements.pageTx.classList.add('hidden');
        } else if (page === 'tx') {
          elements.pageInventory.classList.add('hidden');
          elements.pagePo.classList.add('hidden');
          elements.pageTx.classList.remove('hidden');
        }
      }

      if (elements.tabInventory && elements.tabPo && elements.tabTx) {
        elements.tabInventory.classList.toggle('active', page === 'inventory');
        elements.tabPo.classList.toggle('active', page === 'po');
        elements.tabTx.classList.toggle('active', page === 'tx');
      }

      if (page === 'inventory') {
        applyFilterAndRender();
      } else if (page === 'po') {
        if (poData.length === 0) {
          fetchPo();
        } else {
          applyPoFilterAndRender();
        }
      } else if (page === 'tx') {
        if (txData.length === 0) {
          fetchTransactions();
        } else {
          applyTxFilterAndRender();
          renderNewItemsTable(newItemsData);
        }
      }
    }

    function bindEvents() {
      if (elements.searchInput) {
        elements.searchInput.addEventListener('input', applyFilterAndRender);
      }
      if (elements.poSearchInput) {
        elements.poSearchInput.addEventListener('input', applyPoFilterAndRender);
      }
      if (elements.txSearchInput) {
        elements.txSearchInput.addEventListener('input', applyTxFilterAndRender);
      }
      if (elements.refreshBtn) {
        elements.refreshBtn.addEventListener('click', () => {
          if (currentPage === 'inventory') {
            fetchInventory();
          } else if (currentPage === 'po') {
            fetchPo();
          } else if (currentPage === 'tx') {
            fetchTransactions();
          }
        });
      }
      if (elements.itemName) {
        elements.itemName.addEventListener('change', autoFillUnitFromItem);
        elements.itemName.addEventListener('blur', autoFillUnitFromItem);
      }
      if (elements.adminForm) {
        elements.adminForm.addEventListener('submit', handleAdminSubmit);
      }
      if (elements.tabInventory) {
        elements.tabInventory.addEventListener('click', () => switchPage('inventory'));
      }
      if (elements.tabPo) {
        elements.tabPo.addEventListener('click', () => switchPage('po'));
      }
      if (elements.tabTx) {
        elements.tabTx.addEventListener('click', () => switchPage('tx'));
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      bindEvents();
      fetchInventory();
    });
  </script>
</body>
</html>
